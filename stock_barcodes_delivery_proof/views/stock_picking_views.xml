<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Extend picking form view -->
        <record id="view_picking_delivery_proof_form" model="ir.ui.view">
            <field name="name">stock.picking.delivery.proof.form</field>
            <field name="model">stock.picking</field>
            <field name="inherit_id" ref="stock.view_picking_form" />
            <field name="arch" type="xml">

                <!-- Add Delivery Proof page -->
                <xpath expr="//page[last()]" position="before">
                    <page
                        name="delivery_proof"
                        string="Proof Photos"
                        attrs="{'invisible': [('show_delivery_proof','=',False)]}"
                    >
                        <!-- keep hidden context fields -->
                        <field name="show_delivery_proof" invisible="1" />
                        <field name="delivery_proof_level" invisible="1" />

                        <!-- Picking-level photos section -->
                        <group
                            string="Picking Level Photos"
                            attrs="{'invisible': [('delivery_proof_level','=','move_line')]}"
                        >
                            <field
                                name="picking_proof_image_ids"
                                nolabel="1"
                                colspan="2"
                                context="{'default_picking_id': active_id}"
                            >
                                <kanban class="o_delivery_proof_kanban">
                                    <field name="id" />
                                    <field name="image" />
                                    <field name="capture_date" />
                                    <field name="captured_by_id" />
                                    <field name="picking_id" />
                                    <templates>
                                        <t t-name="kanban-box">
                                            <div class="o_delivery_proof_card">
                                                <div class="o_card_image_container">
                                                    <img
                                                        t-att-src="kanban_image('stock.delivery.proof.image', 'image', record.id.raw_value)"
                                                        alt="Delivery proof"
                                                        class="o_card_image"
                                                    />
                                                    <div class="o_card_image_overlay">
                                                        <button
                                                            name="action_open_gallery"
                                                            type="object"
                                                            class="btn btn-link o_gallery_zoom_btn"
                                                            title="View Gallery"
                                                        >
                                                            <i class="fa fa-search-plus fa-3x"
                                                                title="Zoom" />
                                                        </button>
                                                    </div>
                                                </div>

                                                <div class="o_card_date">
                                                    <i class="fa fa-calendar" title="Capture Date" />
                                                    <field name="capture_date" widget="datetime" />
                                                </div>

                                                <div class="o_card_info_row">
                                                    <div class="o_card_info_col">
                                                        <span class="o_card_label">CAPTURED BY</span>
                                                        <div class="o_card_value">
                                                            <i class="fa fa-user" title="User" />
                                                            <field name="captured_by_id" />
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="o_card_footer">
                                                    <button
                                                        name="action_download_image"
                                                        type="object"
                                                        class="btn btn-link o_card_action_btn"
                                                        title="Download"
                                                    >
                                                        <i class="fa fa-download" />
                                                    </button>
                                                </div>
                                            </div>
                                        </t>
                                    </templates>
                                </kanban>
                            </field>
                        </group>

                        <!-- Move line-level photos section -->
                        <group
                            string="Move Line Level Photos"
                            attrs="{'invisible': [('delivery_proof_level','=','picking')]}"
                        >
                            <field
                                name="move_lines_with_photos"
                                nolabel="1"
                                colspan="2"
                                options="{'no_create': True, 'no_open': True}"
                            >
                                <tree>
                                    <field name="product_id" />
                                    <field name="lot_id" optional="show" />
                                    <field name="qty_done" string="Quantity" />
                                    <field name="product_uom_id" />
                                    <field name="delivery_proof_count" string="Photos" />
                                    <button
                                        name="action_open_line_photos"
                                        type="object"
                                        string="View Photos"
                                        icon="fa-camera"
                                    />
                                </tree>
                            </field>
                        </group>

                    </page>
                </xpath>

            </field>
        </record>

        <!-- Tree view for move lines showing photos -->
        <record id="view_move_line_delivery_proof_tree" model="ir.ui.view">
            <field name="name">stock.move.line.delivery.proof.tree</field>
            <field name="model">stock.move.line</field>
            <field name="arch" type="xml">
                <tree>
                    <field name="product_id" />
                    <field name="lot_id" optional="show" />
                    <!-- Odoo 16: quantity NO existe -> usar qty_done -->
                    <field name="qty_done" string="Quantity" />
                    <field name="product_uom_id" />
                    <field name="delivery_proof_count" string="Photos" />
                    <button
                        name="action_open_line_photos"
                        type="object"
                        string="View Photos"
                        icon="fa-camera"
                        attrs="{'invisible': [('delivery_proof_count','=',0)]}"
                    />
                </tree>
            </field>
        </record>

    </data>
</odoo>